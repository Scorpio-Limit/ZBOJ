function getcookie(name) {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            const value = cookie.substring(name.length + 1);
            return decodeURIComponent(value);
        }
    }
    return null;
}

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
}

function deleteCookie(name) {
    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
}

var user = '';
var mod = '';
var str = '';
var MainPath = "10.31.3.47:9900";
var HomePath = "10.31.3.47:9090"

function logout() {
    deleteCookie('str');
    deleteCookie('name');
    deleteCookie('mod');
}

function out() {
    logout();
    window.location.replace(`http://${HomePath}`);
}

function Letter(num) {
    if (num >= 0 && num <= 25) return String.fromCharCode('a'.charCodeAt(0) + num);
    else if (num >= 26 && num <= 51) return String.fromCharCode('A'.charCodeAt(0) + num - 26);
}

function init() {
    var user = getcookie('name');
    var mod = getcookie('mod');
    var str = getcookie('str');
    document.getElementById("login-button").style = "display: none;";
    document.getElementById("regis-button").style = "display: none;";
    document.getElementById("user-box").style = "display: none;";
    document.getElementById("user-div").style = "display: none";
    if (!user || !mod || !str) {
        logout();
        document.getElementById("login-button").style = "display: block;";
        document.getElementById("regis-button").style = "display: block;";
    }
    else {
        document.getElementById("username-text").innerHTML = user;
        document.getElementById("user-box").style = "display: block;";
        if (mod == 'admin') {
            document.getElementById("admin-button").style = "display: block;";
        }
    }
}
init();

function Login() {
    var name = document.querySelector("#user-input").value;
    var pass = document.querySelector("#pass-input").value;
    if (name.length < 1) {
        document.querySelector("#user-input").value = '';
        document.querySelector("#pass-input").value = '';
        document.querySelector('#wrong1').innerHTML = '用户名不可为空';
        document.querySelector('#wrong1').style = "opacity: 1;";
        return;
    }
    else if (name.length < 3 || name.length > 20) {
        document.querySelector("#user-input").value = '';
        document.querySelector("#pass-input").value = '';
        document.querySelector('#wrong1').innerHTML = '用户名必须介于3到20个字符之间';
        document.querySelector('#wrong1').style = "opacity: 1;";
        return;
    }
    else if (pass.length < 1) {
        document.querySelector("#pass-input").value = '';
        document.querySelector('#wrong2').innerHTML = '密码不可为空';
        document.querySelector('#wrong2').style = "opacity: 1;";
        return;
    }
    else if (pass.length < 6 || pass.length > 30) {
        document.querySelector("#pass-input").value = '';
        document.querySelector('#wrong2').innerHTML = '密码必须介于6到30个字符之间';
        document.querySelector('#wrong2').style = "opacity: 1;";
        return;
    }
    str = '';
    for (var i = 1; i <= 20; ++i) {
        var opt = Math.floor(Math.random() * 2);
        if (!opt) {
            var num = Math.floor(Math.random() * 10);
            str += num;
        }
        else {
            var letter = Letter(Math.floor(Math.random() * 52));
            str += letter;
        }
    }
    fetch(`http://${MainPath}/api/login`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ user: name, pass, str })
    })
        .then(response => response.json())
        .then(data => {
            const res = data.res;
            if (res == "no-user") {
                document.querySelector("#user-input").value = '';
                document.querySelector("#pass-input").value = '';
                document.querySelector('#wrong1').innerHTML = '无此用户';
                document.querySelector('#wrong1').style = "opacity: 1;";
            }
            else if (res == "wrong-pass") {
                document.querySelector("#pass-input").value = '';
                document.querySelector('#wrong2').innerHTML = '密码错误';
                document.querySelector('#wrong2').style = "opacity: 1;";
            }
            else {
                user = document.querySelector("#user-input").value;
                document.querySelector("#user-input").value = '';
                document.querySelector("#pass-input").value = '';
                document.querySelector('#login-box').style = "display: none; opacity: 0;";
                fetch(`http://${MainPath}/api/get`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ user })
                })
                    .then(response => response.json())
                    .then(data => {
                        str = data.str;
                        mod = data.mod;
                        document.getElementById("login-button").style = "display: none;";
                        document.getElementById("regis-button").style = "display: none;";
                        document.getElementById("username-text").innerHTML = user;
                        document.getElementById("user-box").style = "display: block;";
                        setCookie('name', user, 356);
                        setCookie('mod', mod, 356);
                        setCookie('str', str, 356);
                        window.location.reload();
                    })
            }
        })
}
function CheckEmail(email) {
    const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
    return emailRegex.test(email);
}
function Reg() {
    var flag = 0;
    var name = document.querySelector("#user-input2").value;
    var email = document.querySelector("#email-input").value;
    var pass1 = document.querySelector("#pass-input2").value;
    var pass2 = document.querySelector("#pass2-input").value;
    if (name.length < 1) {
        document.querySelector("#user-input2").value = '';
        document.querySelector("#email-input").value = '';
        document.querySelector("#pass-input2").value = '';
        document.querySelector("#pass2-input").value = '';
        document.querySelector('#wrong3').innerHTML = '用户名不可为空';
        document.querySelector('#wrong3').style = "opacity: 1;";
        return;
    }
    else if (name.length < 3 || name.length > 20) {
        document.querySelector("#user-input2").value = '';
        document.querySelector("#email-input").value = '';
        document.querySelector("#pass-input2").value = '';
        document.querySelector("#pass2-input").value = '';
        document.querySelector('#wrong3').innerHTML = '用户名必须介于3到20个字符之间';
        document.querySelector('#wrong3').style = "opacity: 1;";
        return;
    }
    if (CheckEmail(email) == false) {
        document.querySelector("#email-input").value = '';
        document.querySelector('#wrong4').innerHTML = '邮箱格式不正确';
        document.querySelector('#wrong4').style = "opacity: 1;";
    }
    else if (pass1.length < 1) {
        document.querySelector("#pass-input2").value = '';
        document.querySelector("#pass2-input").value = '';
        document.querySelector('#wrong5').innerHTML = '密码不可为空';
        document.querySelector('#wrong5').style = "opacity: 1;";
        return;
    }
    else if (pass1.length < 6 || pass1.length > 30) {
        document.querySelector("#pass-input2").value = '';
        document.querySelector("#pass2-input").value = '';
        document.querySelector('#wrong5').innerHTML = '密码必须介于6到30个字符之间';
        document.querySelector('#wrong5').style = "opacity: 1;";
        return;
    }
    else if (pass2 != pass1) {
        document.querySelector("#pass-input2").value = '';
        document.querySelector("#pass2-input").value = '';
        document.querySelector('#wrong6').innerHTML = '密码不匹配';
        document.querySelector('#wrong6').style = "opacity: 1;";
        return;
    }
    if (name.length >= 3 && name.length <= 20 && CheckEmail(email) == true && pass1.length >= 6 && pass1.length <= 30 && pass1 == pass2) {
        flag = 1;
    }
    if (flag == 1) {
        var str = '';
        for (var i = 1; i <= 20; ++i) {
            var opt = Math.floor(Math.random() * 2);
            if (!opt) {
                var num = Math.floor(Math.random() * 10);
                str += num;
            }
            else {
                var letter = Letter(Math.floor(Math.random() * 52));
                str += letter;
            }
        }
        fetch(`http://${MainPath}/api/reg`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name, email, pass: pass1, str })
        })
            .then(response => response.json())
            .then(data => {
                const res = data.res;
                if (res == "dup") {
                    document.querySelector("#user-input2").value = '';
                    document.querySelector("#email-input").value = '';
                    document.querySelector("#pass-input2").value = '';
                    document.querySelector("#pass2-input").value = '';
                    document.querySelector('#wrong3').innerHTML = '该用户名已被注册';
                    document.querySelector('#wrong3').style = "opacity: 1;";
                }
                else {
                    document.querySelector("#user-input2").value = '';
                    document.querySelector("#email-input").value = '';
                    document.querySelector("#pass-input2").value = '';
                    document.querySelector("#pass2-input").value = '';
                    document.querySelector('#reg-box').style = "display: none; opacity: 0;";
                    document.getElementById("login-button").style = "display: none;";
                    document.getElementById("regis-button").style = "display: none;";
                    document.getElementById("username-text").innerHTML = user;
                    document.getElementById("user-box").style = "display: block;";
                    setCookie('name', name, 356);
                    setCookie('mod', 'common', 356);
                    setCookie('str', str, 356);
                    window.location.reload();
                }
            })
    }
}


document.addEventListener('click', function (event) {
    if (!event.target.closest('#user-div') && !event.target.closest('#user-button')) {
        flag_app = 0;
        document.querySelector('#user-button').style = "color: #414141;";
        document.getElementById("user-div").style = "display: none";
    }
});